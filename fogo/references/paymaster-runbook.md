# Paymaster Runbook

Source: https://dourolabs.notion.site/Paymaster-Runbook-2763e0276d9380268d5bde602d00f887

## Overview

Apps on Fogo use paymasters to fund specified user transactions. **Apps will be expected to fund their individual paymasters on mainnet.** When setting transaction constraints (section 2), account for the economic value generated by and cost of transactions in your fee model.

Transactions funded by the paymaster use your sponsor wallet's FOGO for:
- **Gas and priority fees** — consumed per transaction
- **Rent** — for account creation; reclaimable to sponsor wallet when accounts close

**No one can extract FOGO from your paymaster for their own gain.**

## 1. Find & Fund Your Paymaster Sponsor Address

Get the sponsor (paymaster) key tied to your domain:

```bash
# Testnet
curl "https://fogo-testnet.dourolabs-paymaster.xyz/api/sponsor_pubkey?domain=https://yourapp.example"

# Mainnet
curl "https://fogo-mainnet.dourolabs-paymaster.xyz/api/sponsor_pubkey?domain=https://yourapp.example"
```

Returns a base58 pubkey (`SPONSOR_PUBKEY`).

Fund it:
```bash
solana transfer SPONSOR_PUBKEY AMOUNT_TO_FUND --allow-unfunded-recipient
```

Check balance:
```bash
solana balance SPONSOR_PUBKEY
```

## 2. Define v1 Transaction Variations

A v1 variation = ordered list of instruction constraints + limits. You should have **one variation per distinct on-chain action** a user can take from your frontend that you wish to fund.

### Minimal Structure (TOML)

```toml
[[domains]]
domain = "https://yourapp.example"
enable_session_management = true
enable_preflight_simulation = true

[[domains.tx_variations]]
version = "v1"
name = "Swap"
max_gas_spend = 150000

# Instruction 0
[[domains.tx_variations.instructions]]
program = "TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA"
required = true

# Optional account constraints
[[domains.tx_variations.instructions.accounts]]
index = 0
include = [{ NonFeePayerSigner = {} }]
exclude = []

# Optional data constraint
[[domains.tx_variations.instructions.data]]
start_byte = 0
data_type = "U8"
constraint = { EqualTo = [{ U8 = 3 }] }
```

### Field Reference

**Domain-level:**
- `enable_session_management` — set `true` to pay for session create/revoke (almost always `true`)
- `enable_preflight_simulation` — set `true` to simulate before landing on-chain; failed simulations won't land, saving gas (almost always `true`)

**Variation-level:**
- `version` — `"v1"`
- `name` — stable, unique identifier (e.g., "deposit", "trade", "stake")
- `max_gas_spend` — upper bound compute/gas in lamports (does NOT account for rent or account creation costs)

**Instruction-level:**
- `program` — base58 public key of the program
- `required` — `true` if this instruction must always appear; `false` for optional (e.g., ATA creation, compute budget)
- `accounts[]` (optional) — index + include/exclude constraints
- `data[]` (optional) — start_byte + data_type + constraint

**Data constraints:**
- `EqualTo = [{ U8 = value }]` — byte must equal value (use for discriminators)
- `LessThan = { U8 = value }` — byte must be less than value
- `GreaterThan = { U8 = value }` — byte must be greater than value
- `Neq = [{ U8 = value }]` — byte must not equal value

### Tips

- Omit `accounts`/`data` arrays entirely if unused (empty defaults)
- Use narrowly scoped `EqualTo` constraints for discriminators/opcodes
- For Anchor programs, discriminator = first 8 bytes of `SHA256("global:<function_name>")`

### Submission

Send the TOML (or diff) to the Fogo team through the agreed channel. They load it into the paymaster config and restart/reload.

## 3. Manage Paymaster Spend and Drain

Monitor your sponsor wallet balance. If it runs out, user transactions will fail. Fund proactively based on expected usage.

## Validation CLI

```bash
# Install
cargo install fogo-paymaster --bin paymaster-tx-validator

# Validate a single historical transaction
paymaster-tx-validator validate \
  --config config.toml \
  --rpc-url-http https://testnet.fogo.io \
  --transaction-hash <TRANSACTION_SIGNATURE>

# Validate from base64-encoded transaction
paymaster-tx-validator validate \
  --config config.toml \
  --rpc-url-http https://testnet.fogo.io \
  --transaction <BASE64_ENCODED_TX>

# Validate recent sponsor transactions against a new config
paymaster-tx-validator validate \
  --config config.toml \
  --rpc-url-http https://testnet.fogo.io \
  --recent-sponsor-txs 100
```

## Example: Trading App TOML

```toml
[[domains]]
domain = "https://sessions-example.fogo.io"
enable_session_management = true
enable_preflight_simulation = true

## Deposit
[[domains.tx_variations]]
version = "v1"
name = "Deposit"
max_gas_spend = 500000

# Optional ATA creation (discriminator byte = 1)
[[domains.tx_variations.instructions]]
program = "ATokenGPvbdGVxr1b2hvZbsiqW5xWH25efTNsLJA8knL"
required = false
[[domains.tx_variations.instructions.data]]
start_byte = 0
data_type = "U8"
constraint = { EqualTo = [{ U8 = 1 }] }

# Core deposit (discriminator byte = 12)
[[domains.tx_variations.instructions]]
program = "Examtz9qAwhxcADNFodNA2QpxK7SM9bCHyiaUvWvFBM3"
required = true
[[domains.tx_variations.instructions.accounts]]
index = 0
include = [{ NonFeePayerSigner = {} }]
exclude = []
[[domains.tx_variations.instructions.data]]
start_byte = 0
data_type = "U8"
constraint = { EqualTo = [{ U8 = 12 }] }

## Trade
[[domains.tx_variations]]
version = "v1"
name = "Trade"
max_gas_spend = 800000

# Optional ATA
[[domains.tx_variations.instructions]]
program = "ATokenGPvbdGVxr1b2hvZbsiqW5xWH25efTNsLJA8knL"
required = false
[[domains.tx_variations.instructions.data]]
start_byte = 0
data_type = "U8"
constraint = { EqualTo = [{ U8 = 1 }] }

# Load market (discriminator 10)
[[domains.tx_variations.instructions]]
program = "Examtz9qAwhxcADNFodNA2QpxK7SM9bCHyiaUvWvFBM3"
required = true
[[domains.tx_variations.instructions.accounts]]
index = 0
include = [{ NonFeePayerSigner = {} }]
exclude = []
[[domains.tx_variations.instructions.data]]
start_byte = 0
data_type = "U8"
constraint = { EqualTo = [{ U8 = 10 }] }

# Place order (discriminator 27)
[[domains.tx_variations.instructions]]
program = "Examtz9qAwhxcADNFodNA2QpxK7SM9bCHyiaUvWvFBM3"
required = true
[[domains.tx_variations.instructions.accounts]]
index = 0
include = [{ NonFeePayerSigner = {} }]
exclude = []
[[domains.tx_variations.instructions.data]]
start_byte = 0
data_type = "U8"
constraint = { EqualTo = [{ U8 = 27 }] }
```
